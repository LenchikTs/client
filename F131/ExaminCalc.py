# -*- coding: utf-8 -*-
from PyQt4.QtCore import QDateTime

allAges2018 = set([21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99])
allAges2019 = set([18, 21, 24, 27, 30, 33, 36, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57,
               58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83,
               84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99])
allAgesProf2019 = set([19, 20, 22, 23, 25, 26, 28, 29, 31, 32, 34, 35, 37, 38])

male = 1
female = 2
both = None

examinList2017 = {
    1: (u'Опрос (анкетирование)',
        [['A01.30.009']],
        allAges2018,
        both), 
    2: (u'Антропометрия',
        [['B03.069.003']],
        allAges2018,
        both), 
    3: (u'Измерение артериального давления',
        [['A02.12.002']],
        allAges2018,
        both), 
    4: (u'Определение уровня холестерина', 
        [['A09.05.026.005', 'A09.05.026.006']],
        set([21, 24, 27, 30, 33, 36, 42, 48, 54, 60, 66, 72, 78, 84, 90, 96]),
        both), 
    5: (u'Определение уровня глюкозы', 
        [['A09.05.023.007', 'A09.05.023.002']],
        set([21, 24, 27, 30, 33, 36, 42, 48, 54, 60, 66, 72, 78, 84, 90, 96]),
        both), 
    6: (u'Определение относительного сердечно-сосудистого риска', 
        [['B04.015.008']],
        set([21, 24, 27, 30, 33, 36, 39]),
        both), 
    7: (u'Определение абсолютного сердечно-сосудистого риска', 
        [['B04.015.007']],
        set([42, 45, 48, 51, 54, 57, 60, 63]),
        both), 
    8: (u'Электрокардиография (в покое): для мужчин', 
        [['A05.10.002.003']],
        set([36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        male), 
    9: (u'Электрокардиография (в покое): для женщин', 
        [['A05.10.002.003']],
        set([45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        female),
    10: (u'Осмотр фельдшером (акушеркой)', 
        [['B04.001.009']],
        set([21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69]),
        female),
    11: (u'Флюорография легких',
         [['A06.09.006', 'A06.09.006.001']],
         allAges2018,
         both),
    12: (u'Маммография обеих молочных желез', 
        [['A06.20.004']],
         set([39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75]),
        female), 
    13: (u'Клинический анализ крови', 
        [['B03.016.002']],
         set([21, 24, 27, 30, 33, 36, 42, 48, 54, 60, 66, 72, 78, 84, 90, 96]),
        both), 
    14: (u'Клинический анализ крови развернутый', 
        [['B03.016.003']],
         set([39, 45, 51, 57, 63, 69, 75, 81, 87, 93, 99]),
        both), 
    15: (u'Анализ крови биохимический', 
        [['B03.016.004']],
         set([39, 45, 51, 57, 63, 69, 75, 81, 87, 93, 99]),
        both), 
    16: (u'Общий анализ мочи',
         [['B03.016.006']],
         allAges2018,
         both),
    17: (u'Исследование кала на скрытую кровь', 
        [['A09.19.001', 'A09.19.001.001']],
         set([48, 51, 54, 57, 60, 63, 66, 69, 72, 75]),
        both), 
    18: (u'УЗИ поджелудочной железы, почек, матки и яичников', 
        [['A04.15.001'], ['A04.28.002.001'], ['A04.20.001']],
         set([39, 45, 51, 57, 63, 69, 75, 81, 87, 93, 99]),
        female),
    19: (u'УЗИ поджелудочной железы, почек, простаты и брюшной аорты', 
        [['A04.15.001'], ['A04.28.002.001'], ['A04.21.001']],
         set([39, 45, 51, 57, 63, 69, 75, 81, 87, 93, 99]),
        male),
    20: (u'Измерение внутриглазного давления', 
        [['A12.26.005', 'A12.26.019']],
         set([39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        both), 
    21: (u'Прием врача-терапевта',
         [['B04.026.001.01', 'B04.026.001.02', 'B04.026.001.05', 'B04.026.001.06', 'B04.026.001.09', 'B04.026.001.10', 'B04.026.001.13', 'B04.026.001.14', 'B04.026.001.59',
          'B04.047.001.01', 'B04.047.001.02', 'B04.047.001.05', 'B04.047.001.06', 'B04.047.001.09', 'B04.047.001.10', 'B04.047.001.13', 'B04.047.001.14', 'B04.047.001.59',
          'B04.047.001.40', 'B04.026.001.40', 'B04.026.001.39', 'B04.047.001.39', 'B04.047.001.41', 'B04.026.001.41', 'B04.047.001.42', 'B04.026.001.42', 'B04.047.001.37',
          'B04.026.001.37', 'B04.047.001.38', 'B04.026.001.38', 'B04.047.001.62', 'B04.047.001.63', 'B04.047.001.64', 'B04.047.001.65', 'B04.047.001.66', 'B04.026.001.63',
          'B04.026.001.64', 'B04.026.001.65', 'B04.026.001.66', 'B04.026.001.67', 
          
          'B04.026.001.001', 'B04.026.001.002', 'B04.026.001.005', 'B04.026.001.006', 'B04.026.001.009', 'B04.026.001.010', 'B04.026.001.017', 'B04.026.001.018', 'B04.026.001.021',
          'B04.026.001.022', 'B04.026.001.025', 'B04.026.001.026', 'B04.026.001.037', 'B04.026.001.038', 'B04.026.001.039', 'B04.026.001.040', 'B04.026.001.041', 'B04.026.001.042',
          'B04.026.001.054', 'B04.026.001.056', 'B04.026.001.057', 'B04.026.001.060', 'B04.026.001.062', 'B04.026.001.063', 'B04.026.001.064', 'B04.026.001.066', 'B04.026.001.067',
          'B04.026.001.068', 'B04.026.001.069', 'B04.026.001.070', 'B04.026.001.071', 'B04.026.001.072', 'B04.026.001.073', 'B04.026.001.074', 'B04.026.001.075', 'B04.026.001.076',
          'B04.026.001.077', 'B04.026.001.078', 'B04.026.001.079', 'B04.026.001.080', 'B04.026.001.082', 'B04.026.001.083', 'B04.026.001.084', 
          
          'B04.047.001.001', 'B04.047.001.002', 'B04.047.001.005', 'B04.047.001.006', 'B04.047.001.009', 'B04.047.001.010', 'B04.047.001.017', 'B04.047.001.018', 'B04.047.001.021',
          'B04.047.001.022', 'B04.047.001.025', 'B04.047.001.026', 'B04.047.001.037', 'B04.047.001.038', 'B04.047.001.039', 'B04.047.001.040', 'B04.047.001.041', 'B04.047.001.042',
          'B04.047.001.053', 'B04.047.001.055', 'B04.047.001.056', 'B04.047.001.059', 'B04.047.001.061', 'B04.047.001.062', 'B04.047.001.063', 'B04.047.001.065', 'B04.047.001.066',
          'B04.047.001.067', 'B04.047.001.068', 'B04.047.001.069', 'B04.047.001.070', 'B04.047.001.071', 'B04.047.001.072', 'B04.047.001.073', 'B04.047.001.074', 'B04.047.001.075',
          'B04.047.001.076', 'B04.047.001.077', 'B04.047.001.078', 'B04.047.001.079', 'B04.047.001.080', 'B04.047.001.081', 'B04.047.001.082', 'B04.047.001.083']],
         allAges2018,
         both)
}

examinList2018 = {
    1: (u'Опрос (анкетирование)',
        [['A01.30.026', 'A01.30.009']],
        allAges2018,
        both),
    2: (u'Антропометрия',
        [['B03.069.003']],
        allAges2018,
        both),
    3: (u'Измерение артериального давления',
        [['A02.12.002']],
        allAges2018,
        both),
    4: (u'Определение уровня холестерина',
        [['A09.05.026.005', 'A09.05.026.006', 'A09.05.026.020']],
        set([21, 24, 27, 30, 33, 36, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84]),
        both),
    5: (u'Определение уровня глюкозы',
        [['A09.05.023.006', 'A09.05.023.007', 'A09.05.023.020']],
        set([21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        both),
    6: (u'Определение относительного сердечно-сосудистого риска',
        [['B04.015.008']],
        set([21, 24, 27, 30, 33, 36, 39]),
        both),
    7: (u'Определение абсолютного сердечно-сосудистого риска',
        [['B04.015.007']],
        set([42, 45, 48, 51, 54, 57, 60, 63]),
        both),
    8: (u'Электрокардиография (в покое): для мужчин',
        [['A05.10.002.003']],
        set([36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        male),
    9: (u'Электрокардиография (в покое): для женщин',
        [['A05.10.002.003']],
        set([45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
        female),
    10: (u'Осмотр фельдшером (акушеркой)',
         [['B04.001.009']],
         set([30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60]),
         female),
    11: (u'Флюорография легких',
         [['A06.09.006', 'A06.09.006.001']],
         allAges2018,
         both),
    12: (u'Маммография обеих молочных желез',
         [['A06.20.004']],
         set([39, 42, 45, 48, 54, 60, 66]),
         female),
    13: (u'Исследование кала на скрытую кровь',
         [['A09.19.001', 'A09.19.001.001']],
         set([51, 57, 63, 69]),
         both),
    14: (u'Исследование уровня простатспецифического антигена в крови',
         [['A09.05.130', 'A09.05.130.002']],
         set([45, 51]),
         male),
    15: (u'Измерение внутриглазного давления',
         [['A12.26.005']],
         set([60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99]),
         both),
    16: (u'Индивидуальное профилактическое консультирование',
         [['B04.069.002', 'B04.069.003']],
         set([21, 24, 27, 30, 33, 36, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72]),
         both),
    17: (u'Прием врача-терапевта',
         [['B04.047.001.001', 'B04.047.001.005', 'B04.047.001.009', 'B04.047.001.067',
           'B04.047.001.068', 'B04.047.001.069', 'B04.047.001.002', 'B04.047.001.006',
           'B04.047.001.010', 'B04.047.001.070', 'B04.047.001.071', 'B04.047.001.085',
           'B04.047.001.086', 'B04.047.001.087',

           'B04.026.001.001', 'B04.026.001.005', 'B04.026.001.009', 'B04.026.001.068',
           'B04.026.001.069', 'B04.026.001.070', 'B04.026.001.002', 'B04.026.001.006',
           'B04.026.001.010', 'B04.026.001.071', 'B04.026.001.072', 'B04.026.001.086',
           'B04.026.001.087', 'B04.026.001.088',

           'B04.047.001.075', 'B04.047.001.065', 'B04.047.001.066', 'B04.047.001.076',
           'B04.047.001.077', 'B04.047.001.078', 'B04.047.001.072', 'B04.047.001.062',
           'B04.047.001.063', 'B04.047.001.073', 'B04.047.001.074', 'B04.047.001.088',
           'B04.047.001.089', 'B04.047.001.090', 'B04.047.001.092',

           'B04.026.001.076', 'B04.026.001.066', 'B04.026.001.067', 'B04.026.001.077',
           'B04.026.001.078', 'B04.026.001.079', 'B04.026.001.073', 'B04.026.001.063',
           'B04.026.001.064', 'B04.026.001.074', 'B04.026.001.075', 'B04.026.001.089',
           'B04.026.001.090', 'B04.026.001.091', 'B04.026.001.062', 'B04.047.001.061'

           ]],
         allAges2018,
         both)
}
		
examinList2019 = {
    1: (u'Опрос и анкетирование',
        [['A01.30.026', 'A01.30.009']],
        allAges2019,
        both),
    2: (u'Антропометрия',
        [['B03.069.003']],
        allAges2019,
        both),
    3: (u'Измерение артериального давления',
        [['A02.12.002']],
        allAges2019,
        both),
    4: (u'Определение уровня холестерина',
        [['A09.05.026.005', 'A09.05.026.006', 'A09.05.026.020']],
        allAges2019,
        both),
    5: (u'Определение уровня глюкозы',
        [['A09.05.023.006', 'A09.05.023.007', 'A09.05.023.020']],
        allAges2019,
        both),
    6: (u'Определение относительного сердечно-сосудистого риска',
        [['B04.015.008']],
        set([18, 21, 24, 27, 30, 33, 36, 39]),
        both),
    7: (u'Определение абсолютного сердечно-сосудистого риска',
        [['B04.015.007']],
        set([40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64]),
        both),
    8: (u'Электрокардиография (в покое)',
        [['A05.10.002.003']],
        set([36, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64,
         65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91,
         92, 93, 94, 95, 96, 97, 98, 99]),
        both),
    9: (u'Осмотр фельдшером (акушеркой)',
         [['B04.001.009']],
         allAges2019,
         female),
    10: (u'Флюорография легких',
         [['A06.09.006', 'A06.09.006.001']],
         set([18, 24, 30, 36, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84,
          86, 88, 90, 92, 94, 96, 98]),
         both),
    11: (u'Маммография обеих молочных желез',
         [['A06.20.004']],
         set([40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74]),
         female),
    12: (u'Исследование кала на скрытую кровь',
         [['A09.19.001', 'A09.19.001.001']],
         set([40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75]),
         both),
    13: (u'Исследование уровня простатспецифического антигена в крови',
         [['A09.05.130', 'A09.05.130.002']],
         set([45, 50, 55, 60, 64]),
         male),
    14: (u'Измерение внутриглазного давления',
         [['A12.26.005']],
         set([40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
          67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93,
          94, 95, 96, 97, 98, 99]),
         both),
    15: (u'Индивидуальное профилактическое консультирование',
         [['B04.070.002']],
         set([18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98]),
         both),
    16: (u'ФГДС',
         [['A03.16.001']],
         set([45]),
         both),
    17: (u'Клинический анализ крови',
         [['B03.016.002']],
         set([40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
          67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93,
          94, 95, 96, 97, 98, 99]),
         both),
    18: (u'Цитологическое исследованаие гинекологического мазка',
         [['A08.20.040']],
         set([18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63]),
         female),
    19: (u'Прием врача-терапевта',
         [['B04.047.001.001', 'B04.047.001.005', 'B04.047.001.009', 'B04.047.001.067',
           'B04.047.001.068', 'B04.047.001.069', 'B04.047.001.002', 'B04.047.001.006',
           'B04.047.001.010', 'B04.047.001.070', 'B04.047.001.071', 'B04.047.001.085',
           'B04.047.001.086', 'B04.047.001.087',

           'B04.026.001.001', 'B04.026.001.005', 'B04.026.001.009', 'B04.026.001.068',
           'B04.026.001.069', 'B04.026.001.070', 'B04.026.001.002', 'B04.026.001.006',
           'B04.026.001.010', 'B04.026.001.071', 'B04.026.001.072', 'B04.026.001.086',
           'B04.026.001.087', 'B04.026.001.088',

           'B04.047.001.075', 'B04.047.001.065', 'B04.047.001.066', 'B04.047.001.076',
           'B04.047.001.077', 'B04.047.001.078', 'B04.047.001.072', 'B04.047.001.062',
           'B04.047.001.063', 'B04.047.001.073', 'B04.047.001.074', 'B04.047.001.088',
           'B04.047.001.089', 'B04.047.001.090', 'B04.047.001.092',

           'B04.026.001.076', 'B04.026.001.066', 'B04.026.001.067', 'B04.026.001.077',
           'B04.026.001.078', 'B04.026.001.079', 'B04.026.001.073', 'B04.026.001.063',
           'B04.026.001.064', 'B04.026.001.074', 'B04.026.001.075', 'B04.026.001.089',
           'B04.026.001.090', 'B04.026.001.091', 'B04.026.001.062', 'B04.047.001.061',

           'B04.047.001.093', 'B04.047.001.094', 'B04.047.001.095', 'B04.047.001.096',
           'B04.047.001.097', 'B04.047.001.098', 'B04.047.001.099', 'B04.047.001.100',
           'B04.047.001.101', 'B04.047.001.102', 'B04.047.001.103', 'B04.047.001.104',
           'B04.047.001.105', 'B04.047.001.106',

           'B04.047.002.023', 'B04.047.002.024', 'B04.047.002.025', 'B04.047.002.026',
           'B04.047.002.027', 'B04.047.002.028', 'B04.047.002.029', 'B04.047.002.030',
           'B04.047.002.031', 'B04.047.002.032', 'B04.026.002.023', 'B04.026.002.024',
           'B04.026.002.025', 'B04.026.002.026', 'B04.026.002.027', 'B04.026.002.028',
           'B04.026.002.029', 'B04.026.002.030', 'B04.026.002.031', 'B04.026.002.032'
           ]],
         allAges2019,
         both)
}

examinListProf2019 = {
    1: (u'Опрос и анкетирование',
        [['A01.30.026', 'A01.30.009']],
        allAgesProf2019,
        both),
    2: (u'Антропометрия',
        [['B03.069.003']],
        allAgesProf2019,
        both),
    3: (u'Измерение артериального давления',
        [['A02.12.002']],
        allAgesProf2019,
        both),
    4: (u'Определение уровня холестерина',
        [['A09.05.026.005', 'A09.05.026.006', 'A09.05.026.020']],
        allAgesProf2019,
        both),
    5: (u'Определение уровня глюкозы',
        [['A09.05.023.006', 'A09.05.023.007', 'A09.05.023.020']],
        allAgesProf2019,
        both),
    6: (u'Определение относительного сердечно-сосудистого риска',
        [['B04.015.008']],
        allAgesProf2019,
        both),
    7: (u'Осмотр фельдшером (акушеркой)',
        [['B04.001.009']],
        allAgesProf2019,
        female),
    8: (u'Флюорография легких',
         [['A06.09.006', 'A06.09.006.001']],
         set([20, 22, 26, 28, 32, 34, 38]),
         both),
    9: (u'Электрокардиография (в покое)',
        [['A05.10.002.003']],
        set([35, 37, 38]),
        both),
    10: (u'Прием врача-терапевта',
         [['B04.047.002.013', 'B04.026.002.013', 'B04.047.002.021', 'B04.026.002.021', 'B04.047.002.014', 'B04.047.002.022', 'B04.026.002.014', 'B04.026.002.022', 'B04.026.002', 'B04.047.002',
           'B04.026.002.015', 'B04.026.002.016', 'B04.026.002.017', 'B04.026.002.018', 'B04.026.002.019', 'B04.026.002.020', 'B04.047.002.015', 'B04.047.002.016', 'B04.047.002.017', 'B04.047.002.018',
           'B04.047.002.019', 'B04.047.002.020', 'B04.047.002.023', 'B04.047.002.024', 'B04.047.002.025', 'B04.047.002.026',
           'B04.047.002.027', 'B04.047.002.028', 'B04.047.002.029', 'B04.047.002.030',
           'B04.047.002.031', 'B04.047.002.032', 'B04.026.002.023', 'B04.026.002.024',
           'B04.026.002.025', 'B04.026.002.026', 'B04.026.002.027', 'B04.026.002.028',
           'B04.026.002.029', 'B04.026.002.030', 'B04.026.002.031', 'B04.026.002.032']],
         allAgesProf2019,
         both)
}

def checkCompletion(clientAge, clientSex, eventServices, checkDate, profileCode):
    numTotal = 0
    numCompleted = 0
    numExternal = 0
    notCompletedList = []

    if profileCode in ['8008', '8014']:
        if checkDate >= QDateTime(2019, 5, 1, 0, 0, 0):
            curExaminList = examinList2019
        elif checkDate >= QDateTime(2018, 1, 1, 0, 0, 0):
            curExaminList = examinList2018
        else:
            curExaminList = examinList2017
    elif profileCode == '8011':
        curExaminList = examinListProf2019

    for examinTitle, serviceLists, examinAges, examinSex in curExaminList.itervalues():
        if (clientAge in examinAges and (examinSex == both or clientSex == examinSex)):
            numTotal += 1
            servicesTotal = len(serviceLists)
            servicesCompleted = 0
            servicesExternal = 0
            for serviceList in serviceLists:
                for service in serviceList:
                    if service in eventServices:
                        servicesCompleted += 1
                        (date, external) = eventServices[service]
                        if external:
                            servicesExternal += 1
                        break
            if servicesCompleted == servicesTotal:
                numCompleted += 1
                if servicesExternal > (servicesTotal - servicesExternal):
                    numExternal += 1
            else:
                notCompletedList.append(examinTitle)
                
    return (numTotal, numCompleted, numExternal, notCompletedList)
